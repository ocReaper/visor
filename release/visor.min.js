/**visor
* Angular authentication and authorization library
* @version v0.1.2
* @link  https://github.com/illniyar/visor.git
* @license MIT License, http://www.opensource.org/licenses/MIT
*/

"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="visor"),function(a,b,c){!function(){"use strict";b.module("delayLocationChange",[]).service("delayLocationChange",["$rootScope","$q","$timeout","$location","$injector",function(a,b,c,d,e){function f(a){a.then?i(a):l?i(e.invoke(fn)):k.push(a)}function g(){j--,l&&0>=j&&h()}function h(){d.absUrl()===m?a.$broadcast("$locationChangeSuccess",m,n):d.url(o)}function i(a){j++,a["finally"](g)}var j,k,l,m,n,o,p;return j=0,k=[],l=!1,p=a.$on("$locationChangeStart",function(a,b,f){l=!0,o=d.url(),p(),a.preventDefault(),k.forEach(function(a){i(e.invoke(a))}),0!==j||m||(j++,c(g,1)),m=b,n=f}),f}])}(),function(){"use strict";b.module("visor.allowed",["visor.permissions"]).directive("showIfAllowed",["visorPermissions","$animate",function(a,b){return{restrict:"A",link:function(c,d,e){function f(c){var e=a.checkPermissionsForRoute(c);b[e?"removeClass":"addClass"](d,"ng-hide",{tempClasses:"ng-hide-animate"})}var g=a.notifyOnCacheClear(function(){f(e.showIfAllowed)});e.$observe("showIfAllowed",f),c.$on("$destroy",g)}}}]).directive("classIfRestricted",["visorPermissions","$animate",function(a,b){return{restrict:"A",link:function(c,d,e){function f(c){var f=a.checkPermissionsForRoute(c);b[f?"removeClass":"addClass"](d,e.restrictedClass||"visor-restricted")}var g=a.notifyOnCacheClear(function(){f(e.classIfRestricted)});e.$observe("classIfRestricted",f),c.$on("$destroy",g)}}}])}(),function(){"use strict";b.module("visor",["visor.permissions","visor.ui-router","visor.ngRoute","delayLocationChange","visor.allowed"]).constant("authenticatedOnly",function(a){return!!a}).constant("notForAuthenticated",function(a){return a===b.isUndefined}).provider("visor",function(){var a=this;a.authenticateOnStartup=!0,a.loginRoute="/login",a.homeRoute="/",a.notAuthorizedRoute="/access_denied",a.shouldAddNext=!0,a.authenticate=function(){throw new Error("visorProvider.authenticate must be defined to use visor")},a.doOnNotAuthenticated=["$location","restrictedUrl",function(b,c){b.path(a.loginRoute).search("next",c)}],a.doAfterManualAuthentication=["$location",function(b){b.url(b.search().next||a.homeRoute)}],a.doOnNotAuthorized=["$location",function(b){b.url(a.notAuthorizedRoute)}],this.$get=["$injector","$q","$rootScope","$location","visorPermissions",function(b,d,e,f,g){function h(a){k.authData=a,g.invokeParameters=[k.authData],g.clearPermissionCache()}function i(){k.authData=c,g.invokeParameters=[],g.clearPermissionCache()}var j=!1,k={};return k={authenticate:function(c){var e=d.defer();return j&&!c?j:(j=e.promise,b.invoke(a.authenticate).then(h,i)["finally"](function(){e.resolve(k.authData)}),e.promise)},setAuthenticated:function(c){h(c),j=d.when(c),b.invoke(a.doAfterManualAuthentication,null,{authData:c})},isAuthenticated:function(){return!!k.authData},onNotAllowed:function(c){k.isAuthenticated()?b.invoke(a.doOnNotAuthorized,null,{restrictedUrl:c}):b.invoke(a.doOnNotAuthenticated,null,{restrictedUrl:c})},setUnauthenticated:function(){i()},config:a}}]}).config(["visorPermissionsProvider",function(a){a.doBeforeFirstCheck.push(["visor",function(a){return a.authenticate()}]),a.onNotAllowed=["visor","restrictedUrl",function(a,b){a.onNotAllowed(b)}]}]).run(["visor","delayLocationChange",function(a,b){a.config.authenticateOnStartup&&b(a.authenticate())}])}(),function(){"use strict";b.module("visor.ngRoute",["visor.permissions"]).run(["$rootScope","visorPermissions","$injector",function(a,b,c){var d,e=null;try{e=c.get("$route"),d=!0}catch(f){d=!1}d&&(b.getRoute=function(a){var b;for(var c in e.routes)if(b=e.routes[c],b.regexp.exec(a))return b;return null},a.$on("$routeChangeStart",function(a,c){c.resolve=c.resolve||{},b.onRouteChange(c,function(a){c.resolve._visorDelay=function(){return a}})}))}])}(),function(){"use strict";b.module("visor.permissions",[]).provider("visorPermissions",function(){var a,d=this;d.getPermissionsFromNext=function(a){return a.restrict?[a.restrict]:[]},d.doBeforeFirstCheck=[],d.onNotAllowed=b.noop,d.invokeParameters=[],d.getRoute=function(){throw new Error("method not implemented")},a=!1,this.$get=["$q","$injector","$location",function(e,f,g){function h(a){var c;return a&&0!==a.length?(b.isArray(a)||(a=[a]),c=!0,a.forEach(function(a){c=c&&a.apply(null,l.invokeParameters)}),c):!0}function i(a,b){var c=h(b);return c?!0:(l.invokeNotAllowed(d.onNotAllowed),!1)}var j=[],k={},l={};return j=[],k={},l={onRouteChange:function(b,c){var g,h=l.getPermissionsFromNext(b);return h&&0!==h.length?a?i(b,h):(g=e.defer(),c(g.promise),e.all(d.doBeforeFirstCheck.forEach(function(a){return f.invoke(a)}))["finally"](function(){a=!0,i(b,h)?g.resolve(!0):g.reject(!1)}),"delayed"):!0},getPermissionsFromNext:d.getPermissionsFromNext,checkPermissionsForRoute:function(a){var d,e,f=k[a];return f!==b.isUndefined?f:(d=l.getRoute(a))?(e=l.getPermissionsFromNext(d),f=h(e),k[a]=f,f):c},clearPermissionCache:function(){k={},j.forEach(function(a){a()})},notifyOnCacheClear:function(a){return j.push(a),function(){var b=j.indexOf(a);-1!==b&&j.splice(b,1)}},getRoute:d.getRoute,invokeParameters:d.invokeParameters,invokeNotAllowed:function(a){f.invoke(a,null,{restrictedUrl:g.url()})}}}]})}(),function(){"use strict";b.module("visor.ui-router",["visor.permissions"]).run(["$rootScope","visorPermissions","$injector","$timeout",function(a,c,d,e){var f,g,h;try{d.get("$state"),f=!0}catch(i){f=!1}return f?void d.invoke(["$state",function(b){c.getPermissionsFromNext=function(a){for(var c,d,e=[];a;)a.restrict&&e.unshift(a.restrict),a.parent?a=b.get(a.parent):a.name.indexOf(".")>0?(c=a.name.split("."),c.pop(),d=c.join("."),a=b.get(d)):a=null;return e},g=null,h=!1,a.$on("$stateChangeStart",function(a,d,e){var f;return h?void(h=!1):(g=b.href(d,e).replace(/^#/,""),f=c.onRouteChange(d,function(a){a.then(function(){h=!0,b.go(d,e)})}),void(f&&"delayed"!==f||a.preventDefault()))}),c.invokeNotAllowed=function(a){e(function(){d.invoke(a,null,{restrictedUrl:g})},0)},c.getRoute=function(a){return b.get(a)}}]):b.noop}])}()}(window,window.angular);